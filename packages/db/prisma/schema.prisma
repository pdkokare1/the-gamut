// packages/db/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. CORE DATA: ARTICLES & NARRATIVES
// ==========================================

model Article {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  headline        String
  summary         String
  
  // -- Metadata & Filters --
  source          String
  category        String
  politicalLean   String
  
  url             String   @unique
  imageUrl        String?
  audioUrl        String?
  publishedAt     DateTime @default(now())
  
  // -- AI Analysis --
  analysisType    AnalysisType @default(Full)
  sentiment       Sentiment    @default(Neutral)
  analysisVersion String       @default("3.6") 
  
  // -- Scores & Components (Strictly Typed) --
  biasScore            Float           @default(0)
  biasLabel            String?
  biasComponents       BiasComponents?

  credibilityScore     Float                  @default(0)
  credibilityGrade     String?
  credibilityComponents CredibilityComponents?
  
  reliabilityScore     Float                  @default(0)
  reliabilityGrade     String?
  reliabilityComponents ReliabilityComponents?
  
  trustScore           Float    @default(0)
  trustLevel           String?
  
  // -- Complexity & Bias Detection (New Fields) --
  // Cognitive Load: 0 = Simple/Viral, 100 = Complex/Academic
  complexityScore      Float    @default(50) 
  // Vector-compatible bias: -1 (Left) to 1 (Right)
  detectedBias         Float    @default(0)

  // -- Coverage Stats --
  coverageLeft   Float @default(0)
  coverageCenter Float @default(0)
  coverageRight  Float @default(0)
  
  // -- Clustering & Feed Logic --
  clusterId      Int?
  clusterTopic   String?
  country        String  @default("Global")
  primaryNoun    String?
  secondaryNoun  String?
  
  // Interest Profiling
  topics         String[]

  // Feed Optimization (Hides older versions of same story)
  isLatest       Boolean @default(true)

  // -- Trash / Archive Support --
  deletedAt      DateTime? 
  
  // -- Vector Data --
  embedding      Float[]
  
  keyFindings     String[]
  recommendations String[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // -- Relations --
  // The relation is actively managed on the Profile model via savedArticleIds
  savedByProfileIds String[]      @db.ObjectId

  activityLogs      ActivityLog[]

  // -- Indexes --
  // Note: MongoDB Atlas Search indexes must be managed in Atlas.
  
  // 1. Standard Field Indexes
  @@index([source])
  @@index([trustScore])
  @@index([clusterId])
  @@index([country])
  @@index([category])
  @@index([politicalLean])
  @@index([isLatest])
  @@index([detectedBias])
  @@index([deletedAt])
  @@index([publishedAt(sort: Desc)]) 

  // 2. Compound Indexes
  @@index([category, politicalLean, isLatest, publishedAt(sort: Desc)]) 
  @@index([politicalLean, trustScore(sort: Desc), publishedAt(sort: Desc)])    
  @@index([clusterId, publishedAt(sort: Desc)])            
  @@index([country, category, isLatest, publishedAt(sort: Desc)])       
  @@index([isLatest, publishedAt(sort: Desc)])
  
  @@map("articles")
}

model Narrative {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  clusterId        Int      @unique
  lastUpdated      DateTime @default(now())
  
  masterHeadline   String
  executiveSummary String
  
  sourceCount      Int      @default(0)
  sources          String[]
  
  consensusPoints  String[]
  
  divergencePoints DivergencePoint[]

  category         String?
  country          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("narratives")
}

// ==========================================
// 2. USER DATA: PROFILES & ACTIVITY
// ==========================================

model Profile {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @unique 
  
  email                 String?  @unique
  phoneNumber           String?  @unique
  username              String   @unique
  role                  Role     @default(user)
  
  // -- Stats --
  articlesViewedCount    Int      @default(0)
  comparisonsViewedCount Int      @default(0)
  articlesSharedCount    Int      @default(0)
  
  // -- Gamification --
  currentStreak         Int      @default(0)
  lastActiveDate        DateTime @default(now())
  streakFreezes         Int      @default(1)
  
  habits                Habit[]
  quests                Quest[]
  badges                Badge[]
  
  // -- Saved Content --
  // This is the Active side of the relation
  savedArticles         Article[] @relation(fields: [savedArticleIds], references: [id])
  savedArticleIds       String[]  @db.ObjectId
  
  // -- Personalization --
  userEmbedding         Float[]
  
  // -- Settings & Privacy --
  notificationsEnabled  Boolean  @default(true)
  fcmToken              String?
  isIncognito           Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  activityLogs          ActivityLog[]
  userStats             UserStats?

  @@map("profiles")
}

model UserStats {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @unique
  
  // -- Core Metrics --
  totalTimeSpent        Int      @default(0) 
  articlesReadCount     Int      @default(0)
  
  averageAttentionSpan  Int      @default(0) 
  focusScoreAvg         Float    @default(100) // 0-100
  deepFocusMinutes      Float    @default(0)

  // -- Perspective & Echo Chamber --
  diversityScore        Float    @default(50) // 0-100
  lastLeanSequence      String[] // ["Left", "Right", "Center"]
  lastSentimentSequence String[] // ["Negative", "Positive"]
  suggestPalateCleanser Boolean  @default(false)

  // -- Contextual Exposure --
  leanExposure          LeanExposure?
  leanExposureMorning   LeanExposure?
  leanExposureEvening   LeanExposure?

  // -- Interests & Reading Style --
  readingStyle          ReadingStyle @default(balanced)
  
  // Flexible Maps (Stored as JSON)
  topicInterest         Json? // Map<string, number>
  topicImpressions      Json? // Map<string, number>
  negativeInterest      Json? // Map<string, number> - Ignored topics
  readingProgress       Json? // Map<string, number> - Scroll depth

  lastTimezone          String   @default("UTC")

  // -- Habit & Streak Tracking --
  currentStreak         Int      @default(0)
  longestStreak         Int      @default(0)
  lastActiveDate        DateTime @default(now())
  streakFreezes         Int      @default(1)
  lastFreezeUsed        DateTime?

  // -- Histories & Status --
  dailyHabitStatus      DailyHabitStatus[]
  recentDailyHistory    DailyHistoryEntry[]
  dailyStats            DailyStats?

  activityByHour        Json?    // Map<string, number>
  peakLearningTime      Int?     // 0-23
  
  engagementScore       Float    @default(50)
  lastUpdated           DateTime @default(now())

  user                  Profile  @relation(fields: [userId], references: [userId])

  @@map("userstats") 
}

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  user      Profile  @relation(fields: [userId], references: [userId])
  userId    String   
  
  article   Article? @relation(fields: [articleId], references: [id])
  articleId String?  @db.ObjectId
  
  action    ActionType @default(view_analysis)
  timestamp DateTime   @default(now())

  @@index([userId, timestamp(sort: Desc)])
  @@index([userId, action, timestamp(sort: Desc)])
  @@index([userId, articleId]) // Rapid lookup for "Has user read X?"
  
  @@map("activitylogs")
}

model SearchLog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  query           String
  normalizedQuery String   @unique
  count           Int      @default(1)
  lastSearched    DateTime @default(now())
  zeroResults     Boolean  @default(false)
  resultCountAvg  Float    @default(0)
  
  createdAt       DateTime @default(now())

  @@index([count(sort: Desc)])
  @@index([lastSearched(sort: Desc)])
  
  @@map("searchlogs")
}

// ==========================================
// 3. SYSTEM, AI CONFIG & CACHE
// ==========================================

model Prompt {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  type        PromptType @unique
  text        String
  
  version     Int        @default(1)
  active      Boolean    @default(true)
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("prompts")
}

model SystemConfig {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  // Changed to Json to support Mixed types (Objects, Arrays, Primitives)
  value       Json 
  description String?
  lastUpdated DateTime @default(now())

  @@map("systemconfigs")
}

model EmergencyContact {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  category    String
  serviceName String
  description String?
  number      String
  scope       String   
  hours       String   @default("24x7")
  country     String   @default("India")
  isGlobal    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("emergencycontacts")
}

model Cache {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  data        Json
  expiresAt   DateTime 
  createdAt   DateTime @default(now())
  
  @@map("cache")
}

// ==========================================
// 4. TYPES & ENUMS
// ==========================================

// --- Bias & Analysis Types ---
type BiasComponents {
  linguistic      LinguisticBias
  sourceSelection SourceSelectionBias
  demographic     DemographicBias
  framing         FramingBias
}

type LinguisticBias {
  sentimentPolarity Float
  emotionalLanguage Float
  loadedTerms       Float
  complexityBias    Float
}

type SourceSelectionBias {
  sourceDiversity         Float
  expertBalance           Float
  attributionTransparency Float
}

type DemographicBias {
  genderBalance     Float
  racialBalance     Float
  ageRepresentation Float
}

type FramingBias {
  headlineFraming Float
  storySelection  Float
  omissionBias    Float
}

type CredibilityComponents {
  sourceCredibility Float
  factVerification  Float
  professionalism   Float
  evidenceQuality   Float
  transparency      Float
  audienceTrust     Float
}

type ReliabilityComponents {
  consistency          Float
  temporalStability    Float
  qualityControl       Float
  publicationStandards Float
  correctionsPolicy    Float
  updateMaintenance    Float
}

type DivergencePoint {
  point       String
  perspectives Perspective[]
}

type Perspective {
  source String
  stance String
}

// --- Gamification & Stats Types ---

type Badge {
  id          String
  label       String
  icon        String
  description String
  earnedAt    DateTime @default(now())
}

type Habit {
  type      HabitType
  target    Int
  label     String
  frequency Frequency @default(daily)
}

type Quest {
  id          String
  type        QuestType
  target      Int
  progress    Int       @default(0)
  isCompleted Boolean   @default(false)
  reward      String
  description String
  expiresAt   DateTime
  frequency   Frequency @default(daily)
}

type DailyHabitStatus {
  habitId   String?
  type      HabitType
  current   Int
  target    Int
  completed Boolean
  label     String?
}

type DailyHistoryEntry {
  date         String // YYYY-MM-DD
  timeSpent    Int
  articlesRead Int
  goalsMet     Boolean
}

type DailyStats {
  date         DateTime @default(now())
  timeSpent    Int      @default(0)
  articlesRead Int      @default(0)
  goalsMet     Boolean  @default(false)
}

type LeanExposure {
  Left   Float @default(0)
  Center Float @default(0)
  Right  Float @default(0)
}

// --- Enums ---

enum Role {
  user
  admin
}

enum PromptType {
  ANALYSIS
  GATEKEEPER
  ENTITY_EXTRACTION
}

enum AnalysisType {
  Full
  SentimentOnly
}

enum Sentiment {
  Positive
  Negative
  Neutral
}

enum ActionType {
  view_analysis
  view_comparison
  share_article
  read_external
}

enum ReadingStyle {
  skimmer
  deep_reader
  balanced
  learner
}

enum Frequency {
  daily
  weekly
}

enum HabitType {
  daily_minutes
  daily_articles
  daily_audio
  weekly_articles
}

enum QuestType {
  read_opposing
  read_deep
  share_article
  topic_explorer
}
